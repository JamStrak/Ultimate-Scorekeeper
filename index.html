<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¦œä¸€æˆ˜ç¥ç”Ÿæˆå™¨ v9.4 (ç§¯åˆ†æ’è¡Œæ¦œä¼˜åŒ–ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #1a1a1a; --card-bg: #2c2c2c; --text-color: #eaeaea; --text-muted: #888;
            --primary-gold: #D4AF37; --primary-gold-glow: rgba(212, 175, 55, 0.3); --danger-color: #e57373;
            --danger-button-bg: #B71C1C; --success-color: #4CAF50; --team-a-color: var(--primary-gold);
            --team-a-bg: rgba(212, 175, 55, 0.1); --team-b-color: #26A69A; --team-b-bg: rgba(38, 166, 154, 0.1);
            --border-color: #444; --border-radius: 12px; --shadow: 0 4px 15px rgba(0, 0, 0, 0.2); --transition-speed: 0.3s;
        }
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes score-pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        @keyframes shake-name { 0%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-4px)}20%,40%,60%,80%{transform:translateX(4px)}100%{transform:translateX(0)} }
        @keyframes toast-in-out { 0%, 100% { transform: translate(-50%, 100px); opacity: 0; } 10%, 90% { transform: translate(-50%, 0); opacity: 1; } }

        *, *::before, *::after { box-sizing: border-box; }
        html { -webkit-text-size-adjust: 100%; }
        body { font-family: 'Noto Sans SC', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; -webkit-tap-highlight-color: transparent; overflow-x: hidden; min-height: 100vh; display: flex; justify-content: center; touch-action: manipulation; }
        .container { width: 100%; max-width: 600px; animation: fadeIn 0.5s ease-out; }
        .title-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; position: relative; }
        h1 { color: var(--primary-gold); margin: 0; font-size: clamp(24px, 6vw, 28px); font-weight: 700; letter-spacing: 2px; text-shadow: 0 0 10px var(--primary-gold-glow); }
        .title-icon-btn { background: none; border: none; padding: 5px; cursor: pointer; color: var(--text-muted); transition: color 0.3s; position: absolute; top: 50%; transform: translateY(-50%); }
        .title-icon-btn:hover { color: var(--primary-gold); }
        .title-icon-btn svg { width: 24px; height: 24px; }
        #sessionManagerBtn { right: 0; }
        #helpBtn { left: 0; }
        .pro-feature::after { content: 'Pro'; position: absolute; top: 0; right: 0; background: var(--primary-gold); color: black; font-size: 8px; padding: 1px 3px; border-radius: 4px; font-weight: bold; }
        .main-controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn { padding: 12px 15px; font-size: 15px; font-weight: 500; border: 1px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition-speed) ease; background-color: var(--card-bg); color: var(--text-color); display: flex; justify-content: center; align-items: center; gap: 8px; text-align: center; position: relative; }
        .btn:hover:not(:disabled) { background-color: #383838; border-color: var(--primary-gold); }
        .btn:active:not(:disabled) { transform: scale(0.97); }
        .btn:disabled { background-color: #222; color: var(--text-muted); border-color: #333; cursor: not-allowed; opacity: 0.6; }
        .btn.primary { background-color: var(--primary-gold); color: #1a1a1a; font-weight: 700; border-color: var(--primary-gold); }
        .btn.danger { background-color: transparent; color: var(--danger-button-bg); border-color: var(--danger-button-bg); }
        .btn.danger:hover:not(:disabled), .btn.danger-confirm { background-color: var(--danger-button-bg); color: white; border-color: var(--danger-button-bg); }
        .player-controls { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 8px; background: var(--card-bg); border-radius: var(--border-radius); margin-bottom: 15px; }
        #player-count-display { font-weight: 500; font-size: 16px; margin: 0 5px; }
        .secondary-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
        .switch-container { display: flex; align-items: center; gap: 10px; background-color: var(--card-bg); padding: 8px 12px; border-radius: var(--border-radius); }
        .switch-label { font-size: 14px; color: var(--text-muted); font-weight: 500; }
        .switch-btn { background-color: #555; width: 50px; height: 28px; border-radius: 14px; padding: 3px; cursor: pointer; transition: background-color var(--transition-speed); display: flex; align-items: center; flex-shrink: 0; }
        .switch-btn.active { background-color: var(--primary-gold); }
        .switch-btn-handle { background-color: white; width: 22px; height: 22px; border-radius: 50%; transition: transform var(--transition-speed) ease; }
        .switch-btn.active .switch-btn-handle { transform: translateX(22px); }
        #settingsBtn { font-size: 14px; padding: 8px 12px; background-color: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); border-radius: 8px; flex-shrink: 0; }
        #settingsBtn:hover { border-color: var(--primary-gold); color: var(--primary-gold); }
        .player-list-wrapper { position: relative; }
        .player-list { display: flex; flex-direction: column; gap: 12px; }
        .player-list-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); border-radius: var(--border-radius); z-index: 10; display: flex; justify-content: center; align-items: center; text-align: center; color: white; font-size: 18px; font-weight: 500; padding: 20px; transition: opacity 0.3s, visibility 0.3s; opacity: 0; visibility: hidden; }
        .player-list-overlay.visible { opacity: 1; visibility: visible; }
        .vs-separator-container { display: flex; align-items: center; justify-content: center; padding: 5px 0; gap: 15px;}
        .vs-text { font-size: 22px; font-weight: bold; color: var(--text-muted); }
        #dynamicRecordBtn { padding: 8px 20px; font-size: 14px; background-color: var(--success-color); color: white; border-color: var(--success-color); font-weight: 700; border-radius: 20px; }
        .player-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-left: 5px solid transparent; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 12px 15px; transition: all var(--transition-speed) ease; display: grid; grid-template-columns: auto 1fr auto; grid-template-areas: "nemesis main score" "nemesis name score"; align-items: center; gap: 0 15px; }
        .player-card.rank-1 { background: linear-gradient(145deg, #2c2c2c, #3a321e); border-color: var(--primary-gold); border-left-color: var(--primary-gold); box-shadow: 0 0 20px var(--primary-gold-glow); }
        .player-card.team-a { border-left-color: var(--team-a-color); background-color: var(--team-a-bg); }
        .player-card.team-b { border-left-color: var(--team-b-color); background-color: var(--team-b-bg); }
        .nemesis-icon { grid-area: nemesis; cursor: pointer; width: 28px; height: 28px; color: #666; transition: all var(--transition-speed); }
        .nemesis-icon.active { color: var(--danger-color); transform: scale(1.2); }
        .player-rank-title { grid-area: main; font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 2px; }
        .rank-1 .player-rank-title { color: var(--primary-gold); font-weight: 700; }
        .player-name { grid-area: name; font-weight: 700; font-size: clamp(18px, 5vw, 20px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-name:focus { outline: none; background: rgba(255,255,255,0.1); border-radius: 4px; padding: 0 4px;}
        .player-name.shaking { animation: shake-name 0.5s ease-in-out; }
        .player-scoring { grid-area: score; display: flex; align-items: center; gap: 10px; }
        .score-btn { width: 34px; height: 34px; font-size: 22px; font-weight: 300; border-radius: 50%; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-color); cursor: pointer; transition: all 0.2s; display: inline-flex; justify-content: center; align-items: center; line-height: 1; }
        .player-score { font-weight: 700; font-size: clamp(28px, 8vw, 32px); min-width: 45px; text-align: center; color: var(--primary-gold); transition: color 0.3s; }
        .team-b .player-score { color: var(--team-b-color); }
        .player-score.popping { animation: score-pop 0.3s ease-out; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all var(--transition-speed) ease; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 25px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); transform: scale(0.95); transition: transform var(--transition-speed) ease; max-height: 80vh; overflow-y: auto; }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;}
        .modal-title { font-size: 22px; font-weight: 700; margin: 0; color: var(--primary-gold); }
        .modal-close { font-size: 32px; font-weight: 300; cursor: pointer; color: var(--text-muted); border: none; background: none; line-height: 1; }
        .modal-section-title { font-size: 18px; font-weight: 500; margin-top: 25px; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--primary-gold); }
        .stats-controls { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        #game-session-selector { flex-grow: 1; background-color: #333; border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 8px; font-size: 15px; }
        .stats-list { list-style-type: none; padding: 0; margin: 0; }
        .stats-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--border-color); font-size: 15px; }
        .stats-list li:last-child { border-bottom: none; }
        .rank-list .rank-1-item { background-color: var(--team-a-bg); border-radius: 8px; font-weight: 700; color: var(--primary-gold); }
        .stat-value, .rank-score { font-weight: bold; color: var(--primary-gold); text-align: right; }
        .rank-score small { font-weight: 400; color: var(--text-muted); display: block; font-size: 13px; margin-top: 3px; }
        .rank-list .rank-1-item .rank-score, .rank-list .rank-1-item .rank-score small { color: var(--primary-gold); }
        .settings-list, .session-list { list-style-type: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .settings-list li { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .settings-list .setting-label { color: var(--text-muted); font-weight: bold; min-width: 70px; text-align: right;}
        .settings-list input[type="text"] { flex-grow: 1; background-color: #333; border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 8px; font-size: 16px; }
        .sound-setting .btn-small { padding: 4px 8px; font-size: 12px; border-radius: 6px; }
        .sound-setting .status-text { font-size: 13px; color: var(--text-muted); flex-basis: 100%; margin-left: 80px; }
        .session-list li { background-color: #333; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .session-list li.active-session { background-color: var(--team-a-bg); border: 1px solid var(--primary-gold); }
        .session-name { font-weight: bold; flex-grow: 1; }
        .session-actions .btn-small { padding: 5px; font-size: 14px; background: none; border: none; color: var(--text-muted); }
        .session-actions .btn-small:hover { color: var(--primary-gold); }
        .session-actions .btn-small.delete:hover { color: var(--danger-color); }
        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: var(--primary-gold); color: var(--bg-color); padding: 12px 25px; border-radius: 25px; z-index: 2000; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); opacity: 0; visibility: hidden; }
        #toast-container.show { visibility: visible; animation: toast-in-out 3s ease-in-out forwards; }
        .modal#upgradeModal .modal-content { text-align: center; }
        .pro-feature-list { list-style-type: none; padding: 0; margin: 25px auto; max-width: 280px; text-align: left; }
        .pro-feature-list li { margin-bottom: 12px; position: relative; padding-left: 28px; font-size: 16px; }
        .pro-feature-list li::before { content: 'ğŸ‘‘'; position: absolute; left: 0; top: 0; }
        #goToPurchaseBtn { background-color: var(--primary-gold); color: #1a1a1a; font-weight: 700; border-color: var(--primary-gold); }
        #openActivationLink { color: var(--primary-gold); text-decoration: underline; cursor: pointer; display: block; margin-top: 20px; font-size: 14px; }
        .activation-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .activation-section h4 { color: var(--primary-gold); margin-bottom: 15px; font-weight: 500; }
        #license-key-input { width: 100%; background-color: #333; border: 1px solid var(--border-color); color: var(--text-color); padding: 12px; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        #license-key-input:focus { border-color: var(--primary-gold); outline: none; box-shadow: 0 0 10px var(--primary-gold-glow); }
        #activation-status { color: var(--success-color); font-weight: bold; display: none; margin-top: 10px; }
        #helpModal .modal-content p, #helpModal .modal-content li { line-height: 1.8; color: var(--text-color); }
        #helpModal .modal-content ul { padding-left: 20px; margin-top: 10px;}
        #helpModal .modal-content b { color: var(--primary-gold); }
        .text-input-field { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #333; color: var(--text-color); margin-top: 10px; }
        #comprehensive-stats-view { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main UI -->
        <div class="title-container"><button id="helpBtn" class="title-icon-btn" title="ä½¿ç”¨è¯´æ˜"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></button><h1>æ¦œä¸€æˆ˜ç¥ç”Ÿæˆå™¨</h1><button id="sessionManagerBtn" class="title-icon-btn" title="å­˜æ¡£ç®¡ç†å™¨"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10z"/></svg></button></div>
        <div class="main-controls"><button id="teamUpBtn" class="btn primary">éšæœºç»„é˜Ÿ</button><button id="newRoundBtn" class="btn">æ–°ä¸€å±€</button><button id="statsBtn" class="btn">æ•°æ®ç»Ÿè®¡</button></div>
        <div class="player-controls"><button id="removePlayerBtn" class="btn">-</button><span id="player-count-display">4 ä½ç©å®¶</span><button id="addPlayerBtn" class="btn">+</button></div>
        <div class="secondary-controls"><div id="modeSwitchContainer" class="switch-container"><span id="modeLabel" class="switch-label">ç»„é˜Ÿæ¨¡å¼</span><div id="modeSwitch" class="switch-btn active" title="åˆ‡æ¢è®¡åˆ†æ¨¡å¼"><div class="switch-btn-handle"></div></div></div><div id="repeatSwitchContainer" class="switch-container"><span id="allowRepeatLabel" class="switch-label">é¿å…é‡å¤</span><div id="allowRepeatSwitch" class="switch-btn" title="åˆ‡æ¢ç»„é˜Ÿæ¨¡å¼"><div class="switch-btn-handle"></div></div></div><button id="settingsBtn" class="btn">è®¾ç½®</button></div>
        <div class="player-list-wrapper"><div id="playerList" class="player-list"></div><div id="playerListOverlay" class="player-list-overlay">è¯·ç‚¹å‡» [éšæœºç»„é˜Ÿ] å¼€å§‹</div></div>
    </div>
    
    <!-- Modals -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">æˆ˜å±€åˆ†æ</h2><button class="modal-close">&times;</button></div>
            
            <div id="game-session-view">
                <div class="stats-controls">
                    <select id="game-session-selector"></select>
                    <button id="show-comprehensive-btn" class="btn">æŸ¥çœ‹ç»¼åˆæ•°æ®</button>
                </div>
                <div id="generalStatsContainer"><h3 class="modal-section-title">æœ¬å±€æ•°æ®</h3><ul class="stats-list" id="generalStatsList"></ul></div>
                <div id="rankingsContainer"><h3 class="modal-section-title">æœ¬å±€æ’è¡Œæ¦œ (ç§¯åˆ†)</h3><ul class="stats-list rank-list" id="rankList"></ul></div>
                <div id="teamStatsContainer"><h3 class="modal-section-title">æœ¬å±€CPç»„åˆ</h3><ul class="stats-list" id="teamStatsList"></ul></div>
            </div>

            <div id="comprehensive-stats-view">
                <div class="stats-controls">
                    <button id="show-game-session-btn" class="btn">è¿”å›æˆ˜å±€æ•°æ®</button>
                </div>
                 <div id="comprehensive-generalStatsContainer"><h3 class="modal-section-title">ç»¼åˆæ•°æ® (ç”Ÿæ¶¯æ€»è§ˆ)</h3><ul class="stats-list" id="comprehensive-generalStatsList"></ul></div>
                <div id="comprehensive-rankingsContainer"><h3 class="modal-section-title">ç»¼åˆæ’è¡Œæ¦œ (ç§¯åˆ†)</h3><ul class="stats-list rank-list" id="comprehensive-rankList"></ul></div>
                <div id="comprehensive-teamStatsContainer"><h3 class="modal-section-title">ç»¼åˆCPç»„åˆ</h3><ul class="stats-list" id="comprehensive-teamStatsList"></ul></div>
            </div>

            <div class="modal-footer" style="justify-content: flex-start; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <button id="deleteCurrentArchiveBtn" class="btn danger">åˆ é™¤å½“å‰å­˜æ¡£</button>
            </div>
        </div>
    </div>
    <div id="settingsModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">è®¾ç½®</h2><button class="modal-close">&times;</button></div><div id="settingsContainer"><h3 class="modal-section-title">å…¨å±€è®¾ç½®</h3><div class="switch-container" style="justify-content: space-between; padding: 10px; background: none;"><span class="switch-label" style="font-weight:bold; color: var(--text-color);">å¼€å¯æ‰€æœ‰éŸ³æ•ˆ</span><div id="masterSoundSwitch" class="switch-btn"><div class="switch-btn-handle"></div></div></div><h3 class="modal-section-title">éŸ³æ•ˆåé¦ˆ (å¯é€‰)</h3><ul id="sound-settings-list" class="settings-list"></ul><h3 class="modal-section-title">è‡ªå®šä¹‰ç§°å·</h3><ul id="title-editor-list" class="settings-list"></ul></div><div class="activation-section"><h4 id="activation-title">ä¸“ä¸šç‰ˆæ¿€æ´»</h4><div id="activation-form"><input type="text" id="license-key-input" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„è®¸å¯è¯å¯†é’¥"><button id="activate-btn" class="btn primary" style="width:100%; margin-top:10px;">æ¿€æ´»</button></div><p id="activation-status">âœ… ä¸“ä¸šç‰ˆå·²æ¿€æ´»ã€‚æ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…ä¿å­˜ã€‚</p></div><div class="modal-footer"><button id="restoreDefaultsBtn" class="btn danger">æ¢å¤é»˜è®¤</button><button id="saveSettingsBtn" class="btn primary">ä¿å­˜</button></div></div></div>
    <div id="upgradeModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">ğŸš€ å‡çº§åˆ°ä¸“ä¸šç‰ˆ</h2><button class="modal-close">&times;</button></div><p style="text-align: center; margin-top: 15px; font-size: 16px;">è§£é”å…¨éƒ¨æ½œèƒ½ï¼Œæ°¸ä¹…ä¿å­˜æ‚¨çš„è¾‰ç…Œæˆ˜ç»©ï¼</p><ul class="pro-feature-list"><li><b>å¤šå­˜æ¡£ç³»ç»Ÿï¼š</b>ä¸ºä¸åŒæ¸¸æˆå’Œæœ‹å‹åˆ›å»ºç‹¬ç«‹æˆ˜ç»©</li><li><b>æ·±åº¦æ•°æ®ç»Ÿè®¡ï¼š</b>è§£é”æˆ˜å±€åˆ†æä¸CPç»„åˆæ•°æ®</li><li><b>å®Œå…¨ä¸ªæ€§åŒ–ï¼š</b>è‡ªå®šä¹‰ç©å®¶ç§°å·å’Œæ“ä½œéŸ³æ•ˆ</li><li>æ”¯æŒä¸ªäºº/å›¢é˜ŸåŒè®¡åˆ†æ¨¡å¼</li></ul><div class="modal-footer" style="flex-direction: column; align-items: center; gap: 15px;"><button id="goToPurchaseBtn" class="btn primary" style="width: 80%;">ç«‹å³è´­ä¹°</button><a id="openActivationLink">å·²æœ‰å¯†é’¥ï¼Ÿç‚¹å‡»æ­¤å¤„æ¿€æ´»</a></div></div></div>
    <div id="sessionManagerModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">å­˜æ¡£ç®¡ç†å™¨</h2><button class="modal-close">&times;</button></div><ul id="sessionList" class="session-list"></ul><div class="modal-footer" style="justify-content: center;"><button id="createNewSessionBtn" class="btn primary" style="width: 100%;">åˆ›å»ºæ–°å­˜æ¡£</button></div></div></div>
    <div id="helpModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="modal-title">ä½¿ç”¨è¯´æ˜</h2><button class="modal-close">&times;</button></div><div><h3 class="modal-section-title">åŸºæœ¬æ“ä½œ</h3><p><b>ç©å®¶ç®¡ç†:</b> ä½¿ç”¨ <b>+</b> / <b>-</b> æŒ‰é’®å¢åŠ æˆ–å‡å°‘ç©å®¶æ•°é‡ (2-8äºº)ã€‚<br><b>ç©å®¶æ”¹å:</b> ç›´æ¥ç‚¹å‡»ç©å®¶åç§°å³å¯è¿›è¡Œç¼–è¾‘ï¼Œå®Œæˆåç‚¹å‡»å…¶ä»–åŒºåŸŸä¿å­˜ã€‚</p><h3 class="modal-section-title">è®¡åˆ†æ¨¡å¼</h3><p><b>ä¸ªäººæ¨¡å¼:</b> æ¯ä½ç©å®¶ç‹¬ç«‹è®¡åˆ†ï¼Œé€šè¿‡ç©å®¶å¡ç‰‡å³ä¾§çš„ <b>+</b> / <b>-</b> æŒ‰é’®è¿›è¡ŒåŠ å‡åˆ†ã€‚<br><b>ç»„é˜Ÿæ¨¡å¼:</b> è¿™æ˜¯æ ¸å¿ƒç©æ³•ã€‚æµç¨‹å¦‚ä¸‹ï¼š<ul><li><b>1. éšæœºç»„é˜Ÿ:</b> ç‚¹å‡» <b>[éšæœºç»„é˜Ÿ]</b> æŒ‰é’®ï¼Œç³»ç»Ÿä¼šå°†æ‰€æœ‰ç©å®¶éšæœºåˆ†æˆä¸¤é˜Ÿã€‚</li><li><b>2. å¯¹å±€è®¡åˆ†:</b> ä»»æ„ç»™ä¸€æ–¹é˜Ÿå‘˜åŠ åˆ†ï¼Œåˆ™è¯¥é˜Ÿå…¨ä½“åŠ åˆ†ï¼Œå¦ä¸€é˜Ÿå…¨ä½“å‡åˆ†ã€‚</li><li><b>3. è®°å½•æœ¬å±€:</b> å¯¹å±€ç»“æŸåï¼Œç‚¹å‡»ä¸¤é˜Ÿä¹‹é—´çš„ <b>[è®°å½•æœ¬å±€]</b> æŒ‰é’®ï¼Œè®°å½•èƒœè´Ÿå…³ç³»ã€‚</li></ul><b>å°æç¤ºï¼š</b>åœ¨ä¸€å±€è®¡åˆ†å (å³åˆ†æ•°å‘ç”Ÿå˜åŒ–å)ï¼Œç›´æ¥ç‚¹å‡» <b>[éšæœºç»„é˜Ÿ]</b> ä¹Ÿä¼šè‡ªåŠ¨ä¸ºæ‚¨è®°å½•æœ¬å±€èƒœè´Ÿï¼Œå¹¶ç›´æ¥å¼€å§‹æ–°ä¸€è½®ç»„é˜Ÿã€‚</p><h3 class="modal-section-title">é«˜çº§åŠŸèƒ½</h3><p><b>æ–°ä¸€å±€:</b> ç‚¹å‡» <b>[æ–°ä¸€å±€]</b> ä¼šæ¸…ç©ºæ‰€æœ‰ç©å®¶çš„å½“å‰åˆ†æ•°ï¼Œä½†ä¿ç•™å†å²èƒœè´Ÿæ•°æ®ã€‚<b>(ProåŠŸèƒ½)</b> ç‚¹å‡»åï¼Œä¼šå°†æœ¬å±€æ•°æ®å½’æ¡£ï¼Œå¯åœ¨æ•°æ®ç»Ÿè®¡ä¸­å›é¡¾ã€‚</p><p><b>å®¿æ•ŒæŒ‡å®š:</b> ç‚¹å‡»ç©å®¶å¡ç‰‡æœ€å·¦ä¾§çš„äº¤å‰å‰‘å›¾æ ‡ï¼Œå¯å°†ç©å®¶è®¾ä¸ºâ€œå®¿æ•Œâ€ã€‚åœ¨ç»„é˜Ÿæ—¶ï¼Œå®¿æ•Œä¼šè¢«ä¼˜å…ˆåˆ†åˆ°ä¸åŒé˜Ÿä¼ï¼Œå¢åŠ å¯¹å†³çš„æˆå‰§æ€§ï¼(æœ€å¤šæŒ‡å®š2å)</p><h3 class="modal-section-title">ä¸“ä¸šç‰ˆ (Pro) ç‰¹æƒ</h3><p>å‡çº§åˆ°ä¸“ä¸šç‰ˆåï¼Œä»¥ä¸‹é«˜çº§åŠŸèƒ½å°†ä¸ºæ‚¨è§£é”ï¼š</p><ul><li><b>å­˜æ¡£ç®¡ç†å™¨:</b> (æ ‡é¢˜å³ä¾§æ–‡ä»¶å¤¹å›¾æ ‡) æ‚¨å¯ä»¥åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„å­˜æ¡£ï¼Œä¸ºä¸åŒçš„æœ‹å‹ã€ä¸åŒçš„æ¸¸æˆåœºæ™¯åˆ†åˆ«è®°å½•æˆ˜ç»©ï¼Œæ•°æ®äº’ä¸å¹²æ‰°ã€‚</li><li><b>æ·±åº¦æ•°æ®ç»Ÿè®¡:</b> (ä¸»ç•Œé¢æŒ‰é’®) æŸ¥çœ‹æ€»å±€æ•°ã€å†å²èƒœè´Ÿæ’è¡Œæ¦œå’Œâ€œCPç»„åˆåˆ†æâ€ï¼Œå…¨é¢æŒæ¡æˆ˜å±€ã€‚å¹¶å¯åˆ‡æ¢æŸ¥çœ‹å½“å‰æˆ˜å±€ã€å†å²æˆ˜å±€å’Œç”Ÿæ¶¯ç»¼åˆæ•°æ®ã€‚</li><li><b>å®Œå…¨ä¸ªæ€§åŒ–:</b> (è®¾ç½®æŒ‰é’®) è‡ªç”±ç¼–è¾‘ç©å®¶çš„æ®µä½ç§°å·ï¼Œå¹¶ä¸Šä¼ è‡ªå®šä¹‰çš„æç¤ºéŸ³æ•ˆï¼Œæ‰“é€ ä¸“å±è®¡åˆ†å™¨ã€‚</li></ul></div></div></div>
    <div id="textInputModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="textInputTitle" class="modal-title">è¾“å…¥</h2><button class="modal-close">&times;</button></div><p id="textInputPrompt" style="margin-top: 15px; margin-bottom: 10px; color: var(--text-muted);"></p><input type="text" id="textInputField" class="text-input-field"><div class="modal-footer"><button id="textInputCancelBtn" class="btn">å–æ¶ˆ</button><button id="textInputConfirmBtn" class="btn primary">ç¡®è®¤</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="confirmModalTitle" class="modal-title">è¯·ç¡®è®¤</h2><button class="modal-close">&times;</button></div><p id="confirmModalText" style="margin: 20px 0; font-size: 16px; line-height: 1.6;"></p><div class="modal-footer"><button id="confirmModalCancelBtn" class="btn">å–æ¶ˆ</button><button id="confirmModalConfirmBtn" class="btn primary">ç¡®è®¤</button></div></div></div>

    <div id="toast-container"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const PURCHASE_LINK = "https://mbd.pub/o/bread/YZWUlpxsaw==", MASTER_KEY = "PEAK-DUEL-PRO-2024", PRO_TOKEN_KEY = 'superScorekeeper_v9_proToken', ARCHIVES_KEY = 'superScorekeeper_v9_archives', ACTIVE_SESSION_ID_KEY = 'superScorekeeper_v9_activeSessionId';
        const generateDeviceFingerprint = () => btoa([navigator.userAgent, screen.width, screen.height, navigator.language, new Date().getTimezoneOffset()].join('||')), getProActivationToken = (key, fingerprint) => btoa(`v9.4-${key}-${fingerprint}`), isPro = () => localStorage.getItem(PRO_TOKEN_KEY) === getProActivationToken(MASTER_KEY, generateDeviceFingerprint());

        const playerListEl = document.getElementById('playerList'), addPlayerBtn = document.getElementById('addPlayerBtn'), removePlayerBtn = document.getElementById('removePlayerBtn'), playerCountDisp = document.getElementById('player-count-display'), teamUpBtn = document.getElementById('teamUpBtn'), newRoundBtn = document.getElementById('newRoundBtn'), deleteCurrentArchiveBtn = document.getElementById('deleteCurrentArchiveBtn'), statsBtn = document.getElementById('statsBtn'), toastContainer = document.getElementById('toast-container'), sessionManagerBtn = document.getElementById('sessionManagerBtn'), createNewSessionBtn = document.getElementById('createNewSessionBtn'), sessionListEl = document.getElementById('sessionList'), playerListOverlay = document.getElementById('playerListOverlay');
        const modeSwitch = document.getElementById('modeSwitch'), modeLabel = document.getElementById('modeLabel'), repeatSwitchContainer = document.getElementById('repeatSwitchContainer'), allowRepeatSwitch = document.getElementById('allowRepeatSwitch'), allowRepeatLabel = document.getElementById('allowRepeatLabel');
        const statsModal = document.getElementById('statsModal'), settingsModal = document.getElementById('settingsModal'), upgradeModal = document.getElementById('upgradeModal'), sessionManagerModal = document.getElementById('sessionManagerModal'), helpModal = document.getElementById('helpModal');
        const gameSessionSelector = document.getElementById('game-session-selector'), showComprehensiveBtn = document.getElementById('show-comprehensive-btn'), showGameSessionBtn = document.getElementById('show-game-session-btn'), gameSessionView = document.getElementById('game-session-view'), comprehensiveStatsView = document.getElementById('comprehensive-stats-view');
        const textInputModal = document.getElementById('textInputModal'), textInputTitle = document.getElementById('textInputTitle'), textInputPrompt = document.getElementById('textInputPrompt'), textInputField = document.getElementById('textInputField'), textInputCancelBtn = document.getElementById('textInputCancelBtn'), textInputConfirmBtn = document.getElementById('textInputConfirmBtn');
        const confirmModal = document.getElementById('confirmModal'), confirmModalTitle = document.getElementById('confirmModalTitle'), confirmModalText = document.getElementById('confirmModalText'), confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn'), confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
        const settingsBtn = document.getElementById('settingsBtn'), saveSettingsBtn = document.getElementById('saveSettingsBtn'), restoreDefaultsBtn = document.getElementById('restoreDefaultsBtn'), titleEditorList = document.getElementById('title-editor-list'), soundSettingsList = document.getElementById('sound-settings-list'), masterSoundSwitch = document.getElementById('masterSoundSwitch');
        const licenseKeyInput = document.getElementById('license-key-input'), activateBtn = document.getElementById('activate-btn'), activationForm = document.getElementById('activation-form'), activationStatus = document.getElementById('activation-status'), goToPurchaseBtn = document.getElementById('goToPurchaseBtn'), openActivationLink = document.getElementById('openActivationLink'), helpBtn = document.getElementById('helpBtn');

        let archives = {}, activeSessionId = null, players = [], teamHistory = [], totalRounds = 0, gameMode = 'team', allowRepeats = false, rankTitles = [], customSounds = {}, masterSoundEnabled = true, gameSessions = [];
        let roundIsDirty = false, lastScoringTeam = null, lastTeamComposition = null;
        let textInputAction = null, confirmAction = null;
        
        const DEFAULT_RANK_TITLES = ['ğŸ‘‘ æ¦œä¸€æˆ˜ç¥', 'ğŸ¥ˆ ä¸€æ–¹è±ªå¼º', 'ğŸ¥‰ ä¸­æµç ¥æŸ±', 'æ±Ÿæ¹–å°è™¾', 'åˆå‡ºèŒ…åº', 'æ½œåŠ›æ–°æ˜Ÿ', 'å¾…å±•å®å›¾', 'ä¸å¿˜åˆå¿ƒ'], SOUND_EVENTS = { scoreUp: "åŠ åˆ†åé¦ˆ", teamUp: "ç»„é˜Ÿåé¦ˆ", record: "è®°å½•åé¦ˆ" };
        const NEMESIS_SVG = `<svg class="nemesis-icon-svg" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 9.5l-5 5M9.5 9.5l5 5"/><path d="M2.5 21.5l8-8"/><path d="M16 3l5 5"/><path d="M13.5 6.5l5 5"/><path d="M3 22l4-4"/><path d="M18 2l4 4"/></svg>`, RENAME_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`, DELETE_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;

        function initializeApp() { if (isPro()) { const savedArchives = localStorage.getItem(ARCHIVES_KEY); archives = savedArchives ? JSON.parse(savedArchives) : {}; activeSessionId = localStorage.getItem(ACTIVE_SESSION_ID_KEY); if (!activeSessionId || !archives[activeSessionId]) { const sessionIds = Object.keys(archives); if (sessionIds.length > 0) activeSessionId = sessionIds[0]; else createInitialSession(); } } else { archives = {}; activeSessionId = 'free_session'; if (!archives[activeSessionId]) archives[activeSessionId] = getNewSessionData('å…è´¹ä½“éªŒå­˜æ¡£'); } loadSession(activeSessionId, false); updateUIForProStatus(); }
        function createInitialSession() { const newId = `session_${Date.now()}`; archives[newId] = getNewSessionData('é»˜è®¤å­˜æ¡£'); activeSessionId = newId; saveData(); }
        function loadSessionData(data) { const freshData = JSON.parse(JSON.stringify(data)); players = freshData.players; teamHistory = freshData.teamHistory; totalRounds = freshData.totalRounds; allowRepeats = freshData.allowRepeats || false; gameMode = freshData.gameMode || 'team'; rankTitles = freshData.rankTitles || [...DEFAULT_RANK_TITLES]; customSounds = freshData.customSounds || { scoreUp: null, teamUp: null, record: null }; masterSoundEnabled = typeof freshData.masterSoundEnabled === 'boolean' ? freshData.masterSoundEnabled : true; gameSessions = freshData.gameSessions || []; roundIsDirty = false; lastScoringTeam = null; lastTeamComposition = null; }
        function getNewSessionData(name) { const defaultPlayers = Array.from({ length: 4 }, (_, i) => ({ id: Date.now() + Math.random() + i, name: `ç©å®¶ ${i + 1}`, score: 0, wins: 0, losses: 0, team: null, isNemesis: false })); return { name: name, players: defaultPlayers, teamHistory: [], totalRounds: 0, gameSessions: [], allowRepeats: false, gameMode: 'team', rankTitles: [...DEFAULT_RANK_TITLES], customSounds: { scoreUp: null, teamUp: null, record: null }, masterSoundEnabled: true }; }
        function saveData() { if (!isPro() || !activeSessionId) return; archives[activeSessionId] = { name: archives[activeSessionId]?.name, players, teamHistory, totalRounds, gameSessions, allowRepeats, gameMode, rankTitles, customSounds, masterSoundEnabled }; localStorage.setItem(ARCHIVES_KEY, JSON.stringify(archives)); }
        function createPlayer(doSave = true) { if (players.length >= 8) return; players.push({ id: Date.now() + Math.random(), name: `ç©å®¶ ${players.length + 1}`, score: 0, wins: 0, losses: 0, team: null, isNemesis: false }); renderAll(doSave); }
        function removePlayer() { if (players.length <= 2) return; const removedPlayer = players.pop(); if (players.some(p => p.team)) smartClearTeams(false); [teamHistory, ...gameSessions.map(s => s.teamHistory)].forEach(th => th.forEach(teams => { teams[0] = teams[0].filter(id => id !== removedPlayer.id); teams[1] = teams[1].filter(id => id !== removedPlayer.id); })); renderAll(); }
        function renderAll(doSave = true) { playerListEl.innerHTML = ''; const sortedForRanking = [...players].sort((a, b) => b.score - a.score), rankMap = new Map(sortedForRanking.map((p, i) => [p.id, i])); const isAwaitingTeamUp = gameMode === 'team' && !players.some(p => p.team); playerListOverlay.classList.toggle('visible', isAwaitingTeamUp); const renderQueue = gameMode === 'team' && players.some(p => p.team) ? [...players.filter(p => p.team === 'A'), 'VS_SEPARATOR', ...players.filter(p => p.team === 'B')] : [...players]; renderQueue.forEach(item => { if (item === 'VS_SEPARATOR') { playerListEl.appendChild(createVsSeparator()); } else if(typeof item === 'object' && item.id) { const playerCard = createPlayerCard(item, rankMap); if(isAwaitingTeamUp) playerCard.querySelectorAll('.score-btn').forEach(btn => btn.disabled = true); playerListEl.appendChild(playerCard); } }); updateControlsState(); if (doSave) saveData(); }
        function createPlayerCard(player, rankMap) { const card = document.createElement('div'), rankIndex = rankMap.get(player.id), rankTitle = rankTitles[rankIndex] || rankTitles[rankTitles.length - 1]; card.className = 'player-card'; if (rankIndex === 0) card.classList.add('rank-1'); if (player.team) card.classList.add(`team-${player.team.toLowerCase()}`); card.dataset.playerId = player.id; card.innerHTML = `<div class="nemesis-icon ${player.isNemesis ? 'active' : ''}" data-action="toggle-nemesis" title="è®¾ä¸ºå®¿æ•Œ">${NEMESIS_SVG}</div><span class="player-rank-title">${rankTitle}</span><span class="player-name" contenteditable="true" spellcheck="false">${player.name}</span><div class="player-scoring"><button class="score-btn" data-action="minus">âˆ’</button><span class="player-score">${player.score}</span><button class="score-btn" data-action="plus">+</button></div>`; return card; }
        function createVsSeparator() { const container = document.createElement('div'); container.className = 'vs-separator-container'; const vsText = document.createElement('span'); vsText.className = 'vs-text'; vsText.textContent = 'VS'; const btn = document.createElement('button'); btn.id = 'dynamicRecordBtn'; btn.className = 'btn'; btn.textContent = 'è®°å½•æœ¬å±€'; btn.disabled = !roundIsDirty; container.appendChild(vsText); container.appendChild(btn); return container; }
        function handleScoreChange(playerId, increment) { const player = players.find(p => p.id === playerId); if (!player) return; let affectedPlayers = []; if (gameMode === 'team' && player.team) { const scoringTeam = player.team; lastScoringTeam = scoringTeam; players.forEach(p => { if (p.team) { p.score += (p.team === scoringTeam ? increment : -increment); affectedPlayers.push(p.id); } }); } else { player.score += increment; affectedPlayers.push(player.id); } roundIsDirty = true; if (increment > 0) playSound('scoreUp'); renderAll(); affectedPlayers.forEach(id => { const scoreElToPop = playerListEl.querySelector(`.player-card[data-player-id="${id}"] .player-score`); if (scoreElToPop) { scoreElToPop.classList.add('popping'); scoreElToPop.addEventListener('animationend', () => scoreElToPop.classList.remove('popping'), { once: true }); } }); }
        function smartTeamUp() { setAnimationLock(true); if (players.some(p => p.team)) { if (roundIsDirty && lastScoringTeam) recordRound(true); } document.querySelectorAll('.player-name').forEach(el => el.classList.add('shaking')); playSound('teamUp'); setTimeout(() => { players.forEach(p => p.team = null); roundIsDirty = false; lastScoringTeam = null; const nemeses = players.filter(p => p.isNemesis), available = players.filter(p => !p.isNemesis); let teamA, teamB, teamA_ids; do { teamA = []; teamB = []; if (nemeses.length === 2) { teamA.push(nemeses[0]); teamB.push(nemeses[1]); } else if (nemeses.length === 1) { teamA.push(nemeses[0]); } let shuffled = available.sort(() => 0.5 - Math.random()); shuffled.forEach(p => (teamA.length < players.length / 2) ? teamA.push(p) : teamB.push(p)); if (Math.random() > 0.5) [teamA, teamB] = [teamB, teamA]; teamA_ids = teamA.map(p => p.id).sort(); } while (!allowRepeats && players.length > 2 && lastTeamComposition && JSON.stringify(teamA_ids) === JSON.stringify(lastTeamComposition)); lastTeamComposition = teamA_ids; players.forEach(p => { p.team = teamA.some(pl => pl.id === p.id) ? 'A' : (teamB.some(pl => pl.id === p.id) ? 'B' : null); }); renderAll(); setAnimationLock(false); }, 500); }
        function recordRound(isAuto = false) { if (!roundIsDirty || !lastScoringTeam) return; const winningTeam = lastScoringTeam, losingTeam = winningTeam === 'A' ? 'B' : 'A'; const teamA_ids = players.filter(p => p.team === 'A').map(p => p.id).sort(), teamB_ids = players.filter(p => p.team === 'B').map(p => p.id).sort(); if (teamA_ids.length > 0 && teamB_ids.length > 0) teamHistory.push([teamA_ids, teamB_ids].sort()); players.forEach(p => { if (p.team === winningTeam) p.wins++; else if (p.team === losingTeam) p.losses++; }); totalRounds++; roundIsDirty = false; lastScoringTeam = null; playSound('record'); showToast(isAuto ? 'å·²è‡ªåŠ¨è®°å½•æœ¬å±€' : 'è®°å½•å®Œæˆ'); saveData(); updateControlsState(); }

        // --- Session Management ---
        function showCreateSessionModal() { showTextInputModal('åˆ›å»ºæ–°å­˜æ¡£', 'è¯·è¾“å…¥æ–°å­˜æ¡£çš„åç§°ï¼š', `å¯¹å±€ ${new Date().toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}`, (name) => { const newId = `session_${Date.now()}`; archives[newId] = getNewSessionData(name); activeSessionId = newId; loadSession(newId, true); saveData(); hideModal(sessionManagerModal); }); }
        function loadSession(id, showToastMsg = true) { if (!archives[id]) { initializeApp(); return; } activeSessionId = id; localStorage.setItem(ACTIVE_SESSION_ID_KEY, activeSessionId); loadSessionData(archives[id]); renderAll(false); if (showToastMsg) showToast(`å·²åŠ è½½å­˜æ¡£: ${archives[id].name}`); }
        function renameSession(id) { showTextInputModal('é‡å‘½åå­˜æ¡£', 'è¯·è¾“å…¥æ–°çš„å­˜æ¡£åç§°ï¼š', archives[id].name, (newName) => { archives[id].name = newName; saveData(); renderSessionManager(); }); }
        function deleteSession(idToDelete) { showConfirmModal('ç¡®è®¤åˆ é™¤å­˜æ¡£ï¼Ÿ', `æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤å­˜æ¡£ "${archives[idToDelete].name}" åŠå…¶æ‰€æœ‰æˆ˜å±€å†å²ï¼Œæ— æ³•æ’¤é”€ã€‚`, () => { if (Object.keys(archives).length <= 1 && isPro()) { showToast('æ— æ³•åˆ é™¤å”¯ä¸€çš„å­˜æ¡£'); return; } const deletedName = archives[idToDelete].name, wasActive = idToDelete === activeSessionId; delete archives[idToDelete]; if (wasActive) { const remainingIds = Object.keys(archives); activeSessionId = remainingIds.length > 0 ? remainingIds[0] : null; if (activeSessionId) loadSession(activeSessionId, false); else initializeApp(); } saveData(); renderSessionManager(); showToast(`å­˜æ¡£ "${deletedName}" å·²åˆ é™¤`); if (statsModal.classList.contains('visible')) hideModal(statsModal); }, 'danger-confirm'); }
        function renderSessionManager() { sessionListEl.innerHTML = ''; const sessionIds = Object.keys(archives); if (sessionIds.length === 0) { sessionListEl.innerHTML = '<li>æš‚æ— å­˜æ¡£ï¼Œè¯·åˆ›å»ºä¸€ä¸ªæ–°å­˜æ¡£ã€‚</li>'; return; } sessionIds.forEach(id => { const session = archives[id], li = document.createElement('li'); li.className = (id === activeSessionId) ? 'active-session' : ''; li.dataset.sessionId = id; li.innerHTML = `<span class="session-name">${session.name}</span><div class="session-actions"><button class="btn-small" data-action="rename" title="é‡å‘½å">${RENAME_SVG}</button><button class="btn-small delete" data-action="delete" title="åˆ é™¤">${DELETE_SVG}</button></div>`; const nameSpan = li.querySelector('.session-name'); if (id !== activeSessionId) { nameSpan.style.cursor = 'pointer'; nameSpan.title = 'ç‚¹å‡»åŠ è½½æ­¤å­˜æ¡£'; nameSpan.addEventListener('click', () => { loadSession(id); hideModal(sessionManagerModal); }); } sessionListEl.appendChild(li); }); }

        // --- UI & State Updates ---
        function updateControlsState() { const playerCount = players.length; playerCountDisp.textContent = `${playerCount} ä½ç©å®¶`; addPlayerBtn.disabled = playerCount >= 8; removePlayerBtn.disabled = playerCount <= 2; const isTeamMode = gameMode === 'team'; teamUpBtn.disabled = !isTeamMode || playerCount < 2 || (playerCount > 0 && playerCount % 2 !== 0); repeatSwitchContainer.style.display = isTeamMode ? 'flex' : 'none'; const recordBtn = document.getElementById('dynamicRecordBtn'); if (recordBtn) recordBtn.disabled = !roundIsDirty; updateModeSwitchUI(); updateAllowRepeatSwitchUI(); }
        function toggleMode() { gameMode = (gameMode === 'team' ? 'individual' : 'team'); smartClearTeams(false); saveData(); renderAll(); }
        function updateModeSwitchUI() { modeSwitch.classList.toggle('active', gameMode === 'team'); modeLabel.textContent = gameMode === 'team' ? 'ç»„é˜Ÿæ¨¡å¼' : 'ä¸ªäººæ¨¡å¼'; }
        function toggleAllowRepeats() { allowRepeats = !allowRepeats; saveData(); updateAllowRepeatSwitchUI(); }
        function updateAllowRepeatSwitchUI() { allowRepeatSwitch.classList.toggle('active', allowRepeats); allowRepeatLabel.textContent = allowRepeats ? 'å…è®¸é‡å¤' : 'é¿å…é‡å¤'; }
        function updateUIForProStatus() { const pro = isPro(); activationForm.style.display = pro ? 'none' : 'block'; activationStatus.style.display = pro ? 'block' : 'none'; sessionManagerBtn.classList.toggle('pro-feature', !pro); statsBtn.classList.toggle('pro-feature', !pro); settingsBtn.classList.toggle('pro-feature', !pro); deleteCurrentArchiveBtn.style.display = pro ? 'flex' : 'none'; }
        function activatePro() { if (licenseKeyInput.value.trim() === MASTER_KEY) { localStorage.setItem(PRO_TOKEN_KEY, getProActivationToken(MASTER_KEY, generateDeviceFingerprint())); hideModal(settingsModal); showToast("ä¸“ä¸šç‰ˆæ¿€æ´»æˆåŠŸï¼"); initializeApp(); } else { showToast("æ¿€æ´»ç æ— æ•ˆ"); } }
        function smartClearTeams(autoRecord = true) { if (autoRecord && roundIsDirty && lastScoringTeam) recordRound(true); players.forEach(p => p.team = null); roundIsDirty = false; lastScoringTeam = null; lastTeamComposition = null; renderAll(); }
        function startNewRound() { showConfirmModal('å¼€å§‹æ–°ä¸€å±€ï¼Ÿ', 'è¿™å°†å½’æ¡£å½“å‰æˆ˜å±€æ•°æ®ï¼Œå¹¶æ¸…é›¶æ‰€æœ‰ç©å®¶çš„å½“å‰åˆ†æ•°ã€‚', () => { if (players.some(p => p.score !== 0) || totalRounds > 0) { gameSessions.unshift({ timestamp: Date.now(), players: JSON.parse(JSON.stringify(players)), teamHistory: [...teamHistory], totalRounds }); } players.forEach(p => { p.score = 0; p.wins = 0; p.losses = 0; p.team = null; }); teamHistory = []; totalRounds = 0; roundIsDirty = false; lastScoringTeam = null; lastTeamComposition = null; renderAll(); showToast("æ–°çš„ä¸€å±€å·²å¼€å§‹ï¼"); }); }
        function setAnimationLock(locked) { [teamUpBtn, newRoundBtn, allowRepeatSwitch, modeSwitch].forEach(btn => btn.disabled = locked); if (!locked) updateControlsState(); }
        function playSound(type) { if (masterSoundEnabled && customSounds[type]) { new Audio(customSounds[type]).play().catch(() => {}); } }
        function showToast(message) { toastContainer.textContent = message; toastContainer.classList.add('show'); setTimeout(() => toastContainer.classList.remove('show'), 2500); }
        function showModal(modal) { modal.classList.add('visible'); }
        function hideModal(modal) { modal.classList.remove('visible'); }
        function showTextInputModal(title, prompt, initialValue, onConfirm) { textInputTitle.textContent = title; textInputPrompt.textContent = prompt; textInputField.value = initialValue; textInputAction = onConfirm; showModal(textInputModal); textInputField.focus(); textInputField.select(); }
        function handleTextInputConfirm() { const value = textInputField.value.trim(); if (value && typeof textInputAction === 'function') { textInputAction(value); } else if (!value) { showToast("è¾“å…¥å†…å®¹ä¸èƒ½ä¸ºç©ºï¼"); return; } hideModal(textInputModal); textInputAction = null; }
        function showConfirmModal(title, text, onConfirm, confirmClass = 'primary') { confirmModalTitle.textContent = title; confirmModalText.innerHTML = text; confirmAction = onConfirm; confirmModalConfirmBtn.className = `btn ${confirmClass}`; showModal(confirmModal); }
        function handleConfirm() { if (typeof confirmAction === 'function') confirmAction(); hideModal(confirmModal); confirmAction = null; }

        // --- Stats Rendering Logic ---
        function showStatsModal() { gameSessionView.style.display = 'block'; comprehensiveStatsView.style.display = 'none'; populateSessionSelector(); const currentSessionData = { players: JSON.parse(JSON.stringify(players)), teamHistory: [...teamHistory], totalRounds }; renderSpecificStatsView(currentSessionData, 'current'); showModal(statsModal); }
        function populateSessionSelector() { gameSessionSelector.innerHTML = '<option value="current">å½“å‰æˆ˜å±€</option>'; gameSessions.forEach((session, index) => { const date = new Date(session.timestamp).toLocaleString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}); gameSessionSelector.innerHTML += `<option value="${index}">å†å²æˆ˜å±€: ${date}</option>`; }); }
        function renderSpecificStatsView(data, viewType) { const prefix = viewType === 'comprehensive' ? 'comprehensive-' : ''; const { players: statPlayers, teamHistory: statTeamHistory, totalRounds: statTotalRounds } = data; document.getElementById(`${prefix}generalStatsList`).innerHTML = `<li><span class="stat-name">æ€»å›åˆæ•° (ç»„é˜Ÿ)</span><span class="stat-value">${statTotalRounds}</span></li>`; const rankList = document.getElementById(`${prefix}rankList`); rankList.innerHTML = ''; [...statPlayers].sort((a, b) => b.score - a.score).forEach((player, index) => { const li = document.createElement('li'); if (index === 0 && player.score > 0) li.classList.add('rank-1-item'); const totalGames = player.wins + player.losses, winRate = totalGames > 0 ? Math.round((player.wins / totalGames) * 100) : 0; li.innerHTML = `<span class="rank-name">${index + 1}. ${player.name}</span><span class="rank-score">${player.score}åˆ†<small>${player.wins}èƒœ ${player.losses}è´Ÿ (${winRate}%)</small></span>`; rankList.appendChild(li); }); const teamList = document.getElementById(`${prefix}teamStatsList`); teamList.innerHTML = ''; const pairCounts = {}; statPlayers.forEach((p1, i) => { for (let j = i + 1; j < statPlayers.length; j++) { const key = [p1.id, statPlayers[j].id].sort().join('-'); pairCounts[key] = 0; } }); statTeamHistory.forEach(teams => teams.forEach(team => { if(team.length > 1) { for(let i = 0; i < team.length; i++) for(let j = i + 1; j < team.length; j++) { const key = [team[i], team[j]].sort().join('-'); if (key in pairCounts) pairCounts[key]++; } } })); const sortedPairs = Object.entries(pairCounts).sort(([,a],[,b]) => b-a); if(sortedPairs.length === 0 || sortedPairs.every(p => p[1] === 0)) { teamList.innerHTML = '<li>æš‚æ— ç»„é˜Ÿæ•°æ®</li>'; return; } sortedPairs.forEach(([key, count]) => { if(count === 0) return; const ids = key.split('-').map(Number), p1 = statPlayers.find(p => p.id === ids[0]), p2 = statPlayers.find(p => p.id === ids[1]); if (!p1 || !p2) return; const percentage = statTotalRounds > 0 ? ((count / statTotalRounds) * 100).toFixed(0) : 0; const li = document.createElement('li'); li.innerHTML = `<span class="stat-name">${p1.name} & ${p2.name}</span><span class="stat-value">${count}æ¬¡ (${percentage}%)</span>`; teamList.appendChild(li); }); }
        function renderComprehensiveStats() { const currentSessionData = { players: JSON.parse(JSON.stringify(players)), teamHistory: [...teamHistory], totalRounds }; const allData = [ currentSessionData, ...gameSessions ]; const aggregatedStats = { players: [], teamHistory: [], totalRounds: 0 }; const playerMap = new Map(); allData.forEach(sessionData => { aggregatedStats.totalRounds += sessionData.totalRounds; aggregatedStats.teamHistory.push(...sessionData.teamHistory); sessionData.players.forEach(p => { if (!playerMap.has(p.id)) playerMap.set(p.id, { id: p.id, name: p.name, wins: 0, losses: 0, score: 0 }); const storedPlayer = playerMap.get(p.id); storedPlayer.wins += p.wins; storedPlayer.losses += p.losses; storedPlayer.score += p.score; storedPlayer.name = p.name; }); }); aggregatedStats.players = Array.from(playerMap.values()); renderSpecificStatsView(aggregatedStats, 'comprehensive'); gameSessionView.style.display = 'none'; comprehensiveStatsView.style.display = 'block'; }
        
        function showSettingsModal() { titleEditorList.innerHTML = ''; rankTitles.forEach((title, index) => { titleEditorList.innerHTML += `<li><span class="setting-label">ç¬¬ ${index + 1} å</span><input type="text" value="${title}" data-index="${index}"></li>`; }); soundSettingsList.innerHTML = ''; for (const type in SOUND_EVENTS) { const status = customSounds[type] ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'; soundSettingsList.innerHTML += `<li class="sound-setting" data-sound-type="${type}"><span class="setting-label">${SOUND_EVENTS[type]}</span><label class="btn btn-small">ä¸Šä¼ <input type="file" accept=".mp3,.wav,.m4a" style="display:none;"></label><button class="btn btn-small" data-action="play">è¯•å¬</button><button class="btn btn-small danger" data-action="clear">æ¸…é™¤</button><span class="status-text">${status}</span></li>`; } updateMasterSoundSwitchUI(); settingsModal.classList.add('visible'); }
        function saveSettings() { titleEditorList.querySelectorAll('input').forEach(input => { rankTitles[parseInt(input.dataset.index)] = input.value.trim() || DEFAULT_RANK_TITLES[parseInt(input.dataset.index)]; }); saveData(); renderAll(false); hideModal(settingsModal); showToast('è®¾ç½®å·²ä¿å­˜'); }
        function restoreDefaults() { rankTitles = [...DEFAULT_RANK_TITLES]; customSounds = { scoreUp: null, teamUp: null, record: null }; masterSoundEnabled = true; saveData(); showSettingsModal(); }
        function handleSoundUpload(e) { const file = e.target.files[0], type = e.target.closest('li').dataset.soundType; if (!file || !type) return; const reader = new FileReader(); reader.onload = (event) => { customSounds[type] = event.target.result; saveData(); e.target.closest('li').querySelector('.status-text').textContent = 'å·²è®¾ç½®'; showToast(`${SOUND_EVENTS[type]} éŸ³æ•ˆå·²æ›´æ–°`); }; reader.onerror = () => showToast('æ–‡ä»¶è¯»å–å¤±è´¥'); reader.readAsDataURL(file); }
        function toggleMasterSound() { masterSoundEnabled = !masterSoundEnabled; updateMasterSoundSwitchUI(); saveData(); }
        function updateMasterSoundSwitchUI() { masterSoundSwitch.classList.toggle('active', masterSoundEnabled); }

        // --- Event Listeners ---
        addPlayerBtn.addEventListener('click', () => createPlayer()); removePlayerBtn.addEventListener('click', removePlayer); teamUpBtn.addEventListener('click', smartTeamUp); modeSwitch.addEventListener('click', toggleMode); allowRepeatSwitch.addEventListener('click', toggleAllowRepeats); newRoundBtn.addEventListener('click', startNewRound);
        statsBtn.addEventListener('click', () => isPro() ? showStatsModal() : showModal(upgradeModal));
        deleteCurrentArchiveBtn.addEventListener('click', () => deleteSession(activeSessionId));
        settingsBtn.addEventListener('click', () => isPro() ? showSettingsModal() : showModal(upgradeModal));
        helpBtn.addEventListener('click', () => showModal(helpModal));
        sessionManagerBtn.addEventListener('click', () => isPro() ? (renderSessionManager(), showModal(sessionManagerModal)) : showModal(upgradeModal));
        createNewSessionBtn.addEventListener('click', showCreateSessionModal);
        sessionListEl.addEventListener('click', e => { const btn = e.target.closest('button'); if (!btn) return; const action = btn.dataset.action, sessionId = btn.closest('li').dataset.sessionId; if (action === 'rename') renameSession(sessionId); else if (action === 'delete') deleteSession(sessionId); });
        
        [statsModal, settingsModal, upgradeModal, sessionManagerModal, helpModal, textInputModal, confirmModal].forEach(modal => { modal.addEventListener('click', e => { if (e.target === modal) hideModal(modal); }); modal.querySelector('.modal-close').addEventListener('click', () => hideModal(modal)); });
        textInputConfirmBtn.addEventListener('click', handleTextInputConfirm); textInputField.addEventListener('keydown', e => { if (e.key === 'Enter') handleTextInputConfirm(); }); textInputCancelBtn.addEventListener('click', () => hideModal(textInputModal));
        confirmModalConfirmBtn.addEventListener('click', handleConfirm); confirmModalCancelBtn.addEventListener('click', () => hideModal(confirmModal));
        
        // Stats modal listeners
        gameSessionSelector.addEventListener('change', e => { const value = e.target.value; if (value === 'current') { const currentSessionData = { players: JSON.parse(JSON.stringify(players)), teamHistory: [...teamHistory], totalRounds }; renderSpecificStatsView(currentSessionData, 'game-session'); } else { renderSpecificStatsView(gameSessions[parseInt(value)], 'game-session'); } });
        showComprehensiveBtn.addEventListener('click', renderComprehensiveStats);
        showGameSessionBtn.addEventListener('click', () => { comprehensiveStatsView.style.display = 'none'; gameSessionView.style.display = 'block'; });

        saveSettingsBtn.addEventListener('click', saveSettings); restoreDefaultsBtn.addEventListener('click', restoreDefaults); masterSoundSwitch.addEventListener('click', toggleMasterSound);
        soundSettingsList.addEventListener('change', e => { if (e.target.type === 'file') handleSoundUpload(e); });
        soundSettingsList.addEventListener('click', e => { const target = e.target.closest('button'); if (!target) return; const type = target.closest('li').dataset.soundType; if (target.dataset.action === 'play') playSound(type); if (target.dataset.action === 'clear') { customSounds[type] = null; saveData(); target.closest('li').querySelector('.status-text').textContent = 'æœªè®¾ç½®'; } });
        playerListEl.addEventListener('click', e => { const actionTarget = e.target.closest('[data-action]'); if (e.target.id === 'dynamicRecordBtn') { recordRound(); return; } if (!actionTarget) return; const card = e.target.closest('.player-card'), playerId = parseFloat(card.dataset.playerId), action = actionTarget.dataset.action; if (action === 'toggle-nemesis') { const player = players.find(p => p.id === playerId); if (!player.isNemesis && players.filter(p => p.isNemesis).length >= 2) { showToast('æœ€å¤šåªèƒ½æŒ‡å®šä¸¤åå®¿æ•Œï¼'); return; } player.isNemesis = !player.isNemesis; renderAll(); } else if (action === 'plus' || action === 'minus') { handleScoreChange(playerId, action === 'plus' ? 1 : -1); } });
        playerListEl.addEventListener('blur', e => { if (e.target.classList.contains('player-name')) { const card = e.target.closest('.player-card'), playerId = parseFloat(card.dataset.playerId), player = players.find(p => p.id === playerId), newName = e.target.textContent.trim(); if (player && newName && player.name !== newName) { player.name = newName; saveData(); } else if (!newName) { e.target.textContent = player.name; } } }, true);
        activateBtn.addEventListener('click', activatePro); goToPurchaseBtn.addEventListener('click', () => window.open(PURCHASE_LINK, '_blank')); openActivationLink.addEventListener('click', () => { hideModal(upgradeModal); showModal(settingsModal); });
        
        initializeApp();
    });
    </script>
</body>
</html>
